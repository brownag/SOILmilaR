---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# SOILmilaR

<!-- badges: start -->
[![R-CMD-check](https://github.com/brownag/SOILmilaR/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/brownag/SOILmilaR/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of {SOILmilaR} is to provide methods for applying standardized, customizable "similar soils" rules to site-level data derived from various sources.

The core function to implement this method is `similar_soils()`, which compares a set of soils against one soil type or combination of soil conditions. 
`similar_soils()` can be called iteratively using the `design_mapunit()` function.

The method generally follows the process outlined in Norfleet & Eppinette (1993):

> Norfleet, M.L. and Eppinette, R.T. (1993), A Mathematical Model for Determining Similar and Contrasting Inclusions for Map Unit Descriptons. Soil Survey Horizons, 34: 4-5. <https://doi.org/10.2136/sh1993.1.0004>


## Installation

You can install the development version of SOILmilaR from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("brownag/SOILmilaR")
```

## Example

This is an example that shows you how `similar_soils()` works.

First we generate a synthetic data set using random soil depths across a range of depth classes, as well as random particle size control section clay content and fragments.

Then we apply a subset of taxonomic rules for loamy soils to assign a taxonomic particle size class.
```{r example}
library(SOILmilaR)

data("loamy", package = "SOILmilaR")
```


Then we create some rating functions for properties of interest.

```{r}
rate_taxpartsize <- function(x) {
  dplyr::case_match(x, 
                    c("sandy-skeletal") ~ 1,
                    c("sandy") ~ 3,
                    c("loamy", "coarse-loamy", "coarse-silty") ~ 5,
                    c("fine-loamy", "fine-silty") ~ 7,
                    c("clayey", "fine") ~ 9,
                    c("very-fine") ~ 11,
                    c("loamy-skeletal", "clayey-skeletal") ~ 13,
                    "fragmental" ~ 15)
}

rate_depthclass <- function(x,
                            breaks = c(
                              `very shallow` = 25,
                              `shallow` = 50,
                              `moderately deep` = 100,
                              `deep` = 150,
                              `very deep` = 1e4
                            ),
                            ...) {
  res <- cut(x, c(0, breaks))
  factor(res, levels = levels(res), labels = names(breaks), ordered = TRUE)
}

rate_pscs_clay <- function(x, breaks = c(18, 35, 60, 100)) {
  res <- cut(x, c(0, breaks))
  factor(res, levels = levels(res), ordered = TRUE)
}
```

To run `similar_soils()`, we pass a _data.frame_ or _SoilProfileCollection_ as the first argument. The second argument is a named list that provides a mapping between site-level properties and rating functions. The list elements are functions with minimum arguments `x` and `...`, and the element names are the corresponding columns.

```{r}
m <- list(taxpartsize = rate_taxpartsize,
          depth = rate_depthclass,
          pscs_clay = rate_pscs_clay)

s <- similar_soils(loamy, m)
```

Here we inspect the tabular output of a single run.
```{r}
head(s)
```

The rating values can be used as surrogates for the detailed properties for calculating distance.

Here, we use `cluster::agnes()` to cluster similar sets of rating values, and render a dendrogram.

```{r}
# inspect distances using agglomerative clustering+dendrogram
d <- cluster::agnes(s[, 5, drop = FALSE], method = "gaverage")
d$height <- d$height + 0.2 # fudge factor for 0-distance
plot(stats::as.dendrogram(d), center = TRUE, type = "triangle")
```

If we set `absolute=FALSE` then the differences between soils can be negative, which can help with processing ratings that are ordinal in nature.

```{r}
# allow relative contrast ratings to be negative
# (i.e. ordinal factors, concept of "limiting")
# absolute value is still used for "similar" threshold
s2 <- similar_soils(loamy, m, absolute = FALSE)

# inspect distances unsing agglomerative clustering+dendrogram
d2 <- cluster::agnes(s2[, 5, drop = FALSE], method = "gaverage")
d2$height <- d2$height + 0.2 # fudge factor for 0-distance

plot(stats::as.dendrogram(d2), center = TRUE, type = "triangle")
```

### `design_mapunit()` function

A higher-level wrapper function around `similar_soils()` is `design_mapunit()`. It takes the same inputs as `similar_soils()` but it processes the data iteratively until there are no data remaining to be grouped.

Here we use the same input data.frame and rating function.

```{r}
d <- design_mapunit(loamy, m)

d[order(d$component), ]

sort(prop.table(table(d$component)), decreasing = TRUE)
```

If we assume that the collection observations in `x` are spatially representative of the mapunit extent, it is reasonable to consider the resulting proportions to be similar to the abundance represented with component percentages.

A literal interpretation of this output would result in a map unit with 5 groups of similar soils, of which 4 could be major components. Alpha appears to be dominant, Beta and Gamma are co-dominant in second place, Delta and Epsilon are dissimilar, limiting, and very strongly contrasting, with Epsilon as a minor component.

```{r}
apply(d[3:5], 2, \(dd) {
  aggregate(dd, by = list(component = d$component), quantile)
})
```

If we summarize the properties of the resulting groups, we have:

 - Alpha: moderately deep to deep, loamy-skeletal
 - Beta: deep to moderately deep, fine-loamy
 - Gamma: deep to moderately deep, coarse-loamy
 - Delta: shallow, loamy
 - Epsilon: moderately deep to deep, fragmental

Depending on the context of where these soils occur within the mapunit, one may opt to further combine (or perhaps split out) unique conditions as the pertain to unique soil properties, landforms, and vegetation.

Also, perhaps some of the rating functions could be adjusted. If Beta and Gamma appear too similar, the rating groups that split coarse and fine loamy could be combined.
